<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cigar Reveal</title>
  <style>
    :root{
      --bg:#0c0c0d; --panel:#141416; --panel-2:#1b1c1f;
      --text:#f4f4f6; --muted:#b7b8bd; --brand:#d4af37; --border:#2a2b30; --chip:#222327;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7f9; --panel:#ffffff; --panel-2:#ffffff; --text:#1e2127; --muted:#60636b; --border:#e6e7eb; --chip:#f1f2f4 }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:940px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;gap:12px;padding:14px 18px;margin:16px 0 24px;
      background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    .logo{inline-size:42px;block-size:42px;border-radius:10px;background: radial-gradient(circle at 30% 30%, var(--brand), #b3942f 60%);
      display:grid;place-items:center;color:#111;font-weight:800;border:1px solid rgba(212,175,55,.35)}
    .titleblock h1{margin:0;font-size:1.55rem;letter-spacing:.3px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:22px;box-shadow:0 8px 26px rgba(0,0,0,.12)}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:18px;grid-template-columns:1.1fr .9fr}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }
    .kv{display:grid;grid-template-columns:180px 1fr;gap:10px}
    @media (max-width: 560px){ .kv{grid-template-columns:120px 1fr} }
    .label{color:var(--muted)}
    .value{font-weight:600;word-break:break-word}
    .qrbox{border:1px dashed var(--border);border-radius:16px;padding:16px;display:grid;place-items:center;min-height:280px;background:var(--panel-2)}
    img{max-width:100%;height:auto}
    a{color:var(--brand)}
    .hidden{display:none}
    .small{font-size:.9rem}
    .form{margin-top:18px;border-top:1px solid var(--border);padding-top:18px}
    .form h2{font-size:1.15rem;margin:.3rem 0 1rem}
    .stars{display:flex;gap:6px;align-items:center}
    .star{font-size:28px;cursor:pointer;user-select:none;transition: transform .05s ease}
    .star:hover{transform: scale(1.1)}
    .star[data-active="true"]{color:var(--brand)}
    .rows{display:grid;gap:14px}
    .row{display:grid;grid-template-columns:200px 1fr;gap:10px;align-items:center}
    @media (max-width: 600px){ .row{grid-template-columns:1fr} }
    .yn{display:flex;gap:8px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);cursor:pointer}
    .chip[data-on="true"]{background:linear-gradient(180deg,#e8d48a,var(--brand));color:#111;border-color:#c6a531}
    textarea{width:100%;min-height:110px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);text-decoration:none;color:var(--text);background:var(--chip);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#e8d48a,var(--brand));color:#111;border-color:#c6a531}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.18)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">C</div>
      <div class="titleblock">
        <h1>Cigar Reveal</h1>
      </div>
      <div style="flex:1"></div>
    </div>

    <div id="status" class="panel muted">Loading…</div>

    <div id="detail" class="panel hidden">
      <div class="grid">
        <div>
          <div id="fields" class="kv"></div>
          <div class="form">
            <h2>Rate this cigar</h2>
            <div class="rows">
              <div class="row" data-key="flavour_profile">
                <div class="label">Flavour profile</div>
                <div class="stars" data-stars="flavour_profile"></div>
              </div>
              <div class="row" data-key="appearance">
                <div class="label">Appearance</div>
                <div class="stars" data-stars="appearance"></div>
              </div>
              <div class="row" data-key="draw">
                <div class="label">Draw</div>
                <div class="stars" data-stars="draw"></div>
              </div>
              <div class="row" data-key="construction">
                <div class="label">Construction</div>
                <div class="stars" data-stars="construction"></div>
              </div>
              <div class="row" data-key="overall">
                <div class="label">Overall</div>
                <div class="stars" data-stars="overall"></div>
              </div>
              <div class="row" data-key="order_again">
                <div class="label">Would you like to order this cigar?</div>
                <div class="yn">
                  <div class="chip" data-yn="order_again" data-value="Yes">Yes</div>
                  <div class="chip" data-yn="order_again" data-value="No">No</div>
                </div>
              </div>
              <div class="row" data-key="gift_smoke">
                <div class="label">Would you smoke this if received as a gift?</div>
                <div class="yn">
                  <div class="chip" data-yn="gift_smoke" data-value="Yes">Yes</div>
                  <div class="chip" data-yn="gift_smoke" data-value="No">No</div>
                </div>
              </div>
              <div class="row" data-key="guessed_flavour">
                <div class="label">Did you guess the flavouring right?</div>
                <div class="yn">
                  <div class="chip" data-yn="guessed_flavour" data-value="Yes">Yes</div>
                  <div class="chip" data-yn="guessed_flavour" data-value="No">No</div>
                </div>
              </div>
              <div class="row" data-key="feedback">
                <div class="label">Overall feedback (optional)</div>
                <div><textarea id="feedbackBox" placeholder="Share your experience…"></textarea></div>
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" id="submit">Send feedback</button>
              <button class="btn" id="copyJson">Copy JSON</button>
            </div>
            <div class="muted small" style="margin-top:8px">Your feedback is used to improve future selections.</div>
          </div>
        </div>
        <div>
          <div class="small muted" style="margin-bottom:8px">QR code</div>
          <div class="qrbox"><canvas id="qrCanvas" width="320" height="320"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    const EMAIL = "you@example.com"; // replace with your address or switch to EmailJS later
    const JSON_CANDIDATES = ["./items_v2.json","./items.json"];
    function qs(k){return new URL(window.location.href).searchParams.get(k);}
    function showToast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),1800); }
    function nice(v){ return (v && String(v).trim()) ? v : "Not specified"; }

    async function loadData(){
      for(const url of JSON_CANDIDATES){
        try{ const r=await fetch(url,{cache:"no-store"}); if(r.ok){ return await r.json(); } }catch(e){}
      }
      throw new Error("Could not load items JSON. Upload items_v2.json or items.json next to index.html.");
    }

    function field(k,v){
      const L=document.createElement("div"); L.className="label"; L.textContent=k;
      const V=document.createElement("div"); V.className="value"; V.textContent=v;
      return [L,V];
    }

    function renderStars(containerKey, initial=0){
      const wrap = document.querySelector(`.stars[data-stars="${containerKey}"]`);
      wrap.innerHTML="";
      for(let i=1;i<=5;i++){
        const s=document.createElement("span"); s.className="star"; s.textContent="★"; s.dataset.value=String(i);
        s.addEventListener("click", ()=> setStarValue(containerKey, i));
        wrap.appendChild(s);
      }
      setStarValue(containerKey, initial);
    }
    function setStarValue(key, val){
      const wrap=document.querySelector(`.stars[data-stars="${key}"]`);
      wrap.querySelectorAll(".star").forEach(el=>{
        el.dataset.active = Number(el.dataset.value) <= val ? "true":"false";
      });
      wrap.dataset.value = String(val);
    }
    function getStarValue(key){
      const wrap=document.querySelector(`.stars[data-stars="${key}"]`);
      return Number(wrap?.dataset?.value || 0);
    }
    function bindYesNo(key){
      document.querySelectorAll(`.chip[data-yn="${key}"]`).forEach(el=>{
        el.addEventListener("click", ()=>{
          document.querySelectorAll(`.chip[data-yn="${key}"]`).forEach(c=>c.dataset.on="false");
          el.dataset.on="true";
        });
      });
    }
    function getYesNo(key){
      const on = document.querySelector(`.chip[data-yn="${key}"][data-on="true"]`);
      return on ? on.dataset.value : "";
    }

    function exportPayload(id, rec){
      return {
        id, brand: rec.Brand||"", name: rec.Name||"", vitola: rec.Vitola||"",
        ratings:{
          flavour_profile: getStarValue("flavour_profile"),
          appearance: getStarValue("appearance"),
          draw: getStarValue("draw"),
          construction: getStarValue("construction"),
          overall: getStarValue("overall"),
        },
        questions:{
          order_again: getYesNo("order_again"),
          gift_smoke: getYesNo("gift_smoke"),
          guessed_flavour: getYesNo("guessed_flavour"),
        },
        feedback: (document.getElementById("feedbackBox").value||"").trim(),
        timestamp: new Date().toISOString()
      };
    }

    function sendEmail(payload){
      const subject = encodeURIComponent(`CRC Rating: ${payload.id} — ${payload.name}`);
      const body = encodeURIComponent(JSON.stringify(payload, null, 2));
      window.location.href = `mailto:${encodeURIComponent(EMAIL)}?subject=${subject}&body=${body}`;
    }

    (async function(){
      try{
        const data = await loadData();
        const id = qs("id");
        if(!id){ throw new Error("Missing ID in the URL. Open this page from a valid QR link."); }
        const rec = data[id];
        if(!rec){ throw new Error("No match for this code. Please check the QR or contact support."); }

        document.getElementById("status").classList.add("hidden");
        document.getElementById("detail").classList.remove("hidden");

        const fields=document.getElementById("fields");
        const keys=["Batch","Brand","Name","Vitola","Origin","Wrapper","Binder","Filler","Strength","Flavour","Notes","ID"];
        keys.forEach(k=>{ const [L,V]=field(k,nice(rec[k])); fields.appendChild(L); fields.appendChild(V); });

        // QR with CDN library
        const cv = document.getElementById("qrCanvas");
        QRCode.toCanvas(cv, rec.QR_URL || window.location.href, { width: 320 }, function (error) {
          if (error) console.error(error);
        });

        // Form setup
        ["flavour_profile","appearance","draw","construction","overall"].forEach(k=> renderStars(k,0));
        ["order_again","gift_smoke","guessed_flavour"].forEach(bindYesNo);

        document.getElementById("copyJson").onclick = async ()=>{
          const payload = exportPayload(id, rec);
          await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
          showToast("Copied JSON");
        };
        document.getElementById("submit").onclick = ()=>{
          const payload = exportPayload(id, rec);
          sendEmail(payload);
        };

      }catch(e){
        const s=document.getElementById("status");
        s.textContent = e.message;
      }
    })();
  </script>
</body>
</html>
