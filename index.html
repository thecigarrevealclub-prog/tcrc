<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cigar Reveal</title>
  <style>
    :root{
      --bg:#0c0c0d; --panel:#141416; --panel-2:#1b1c1f;
      --text:#f4f4f6; --muted:#b7b8bd; --brand:#d4af37; --border:#2a2b30; --chip:#222327;
      --danger:#ff6b6b; --ok:#2ecc71;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7f9; --panel:#ffffff; --panel-2:#ffffff; --text:#1e2127; --muted:#60636b; --border:#e6e7eb; --chip:#f1f2f4 }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;gap:12px;padding:14px 18px;margin:16px 0 24px;
      background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    .logo{inline-size:42px;block-size:42px;border-radius:10px;background: radial-gradient(circle at 30% 30%, var(--brand), #b3942f 60%);
      display:grid;place-items:center;color:#111;font-weight:800;border:1px solid rgba(212,175,55,.35)}
    .titleblock h1{margin:0;font-size:1.55rem;letter-spacing:.3px}
    .titleblock .sub{color:var(--muted);font-size:.95rem;margin-top:2px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:22px;box-shadow:0 8px 26px rgba(0,0,0,.12)}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 14px}
    .btn,.linkbtn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);text-decoration:none;color:var(--text);background:var(--chip);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#e8d48a,var(--brand));color:#111;border-color:#c6a531}
    .grid{display:grid;gap:18px;grid-template-columns:1.1fr .9fr}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .kv{display:grid;grid-template-columns:180px 1fr;gap:10px}
    @media (max-width: 560px){ .kv{grid-template-columns:120px 1fr} }
    .label{color:var(--muted)}
    .value{font-weight:600;word-break:break-word}
    .qrbox{border:1px dashed var(--border);border-radius:16px;padding:16px;display:grid;place-items:center;min-height:280px;background:var(--panel-2)}
    img{max-width:100%;height:auto}
    .list .item{padding:16px;border:1px solid var(--border);border-radius:14px;margin-bottom:12px;display:flex;justify-content:space-between;gap:10px;background:var(--panel)}
    .list .meta{color:var(--muted);font-size:.9rem}
    input[type="search"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text)}
    a{color:var(--brand)}
    .hidden{display:none}
    .small{font-size:.9rem}

    /* Rating form */
    .form{margin-top:18px;border-top:1px solid var(--border);padding-top:18px}
    .form h2{font-size:1.15rem;margin:.3rem 0 1rem}
    .stars{display:flex;gap:6px;align-items:center}
    .star{font-size:28px;cursor:pointer;user-select:none;transition: transform .05s ease}
    .star:hover{transform: scale(1.1)}
    .star[data-active="true"]{color:var(--brand)}
    .rows{display:grid;gap:14px}
    .row{display:grid;grid-template-columns:200px 1fr;gap:10px;align-items:center}
    @media (max-width: 600px){ .row{grid-template-columns:1fr} }
    .yn{display:flex;gap:8px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);cursor:pointer}
    .chip[data-on="true"]{background:linear-gradient(180deg,#e8d48a,var(--brand));color:#111;border-color:#c6a531}
    textarea{width:100%;min-height:110px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .note{margin-top:8px;color:var(--muted);font-size:.9rem}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.18)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">C</div>
      <div class="titleblock">
        <h1>Cigar Reveal</h1>
        <div class="sub muted">Elegant reveal + member rating</div>
      </div>
      <div style="flex:1"></div>
      <a class="btn" href="./">List</a>
    </div>

    <div id="status" class="panel muted">Loading…</div>

    <div id="detail" class="panel hidden">
      <div class="controls">
        <a class="btn" href="./">← Back to list</a>
        <a id="openLink" class="btn primary" href="#" target="_blank">Open official link</a>
      </div>
      <div class="grid">
        <div>
          <div id="fields" class="kv"></div>
          <div class="form">
            <h2>Member Rating</h2>
            <div class="rows">
              <div class="row" data-key="flavour_profile">
                <div class="label">Flavour profile</div>
                <div class="stars" data-stars="flavour_profile"></div>
              </div>
              <div class="row" data-key="appearance">
                <div class="label">Appearance</div>
                <div class="stars" data-stars="appearance"></div>
              </div>
              <div class="row" data-key="draw">
                <div class="label">Draw</div>
                <div class="stars" data-stars="draw"></div>
              </div>
              <div class="row" data-key="construction">
                <div class="label">Construction</div>
                <div class="stars" data-stars="construction"></div>
              </div>
              <div class="row" data-key="overall">
                <div class="label">Overall</div>
                <div class="stars" data-stars="overall"></div>
              </div>
              <div class="row" data-key="order_again">
                <div class="label">Would you like to order this cigar?</div>
                <div class="yn">
                  <div class="chip" data-yn="order_again" data-value="Yes">Yes</div>
                  <div class="chip" data-yn="order_again" data-value="No">No</div>
                </div>
              </div>
              <div class="row" data-key="gift_smoke">
                <div class="label">Would you smoke this if received as a gift?</div>
                <div class="yn">
                  <div class="chip" data-yn="gift_smoke" data-value="Yes">Yes</div>
                  <div class="chip" data-yn="gift_smoke" data-value="No">No</div>
                </div>
              </div>
              <div class="row" data-key="guessed_flavour">
                <div class="label">Did you guess the flavouring right?</div>
                <div class="yn">
                  <div class="chip" data-yn="guessed_flavour" data-value="Yes">Yes</div>
                  <div class="chip" data-yn="guessed_flavour" data-value="No">No</div>
                </div>
              </div>
              <div class="row" data-key="feedback">
                <div class="label">Overall feedback (optional)</div>
                <div><textarea id="feedbackBox" placeholder="Share your experience…"></textarea></div>
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" id="saveLocal">Save</button>
              <button class="btn" id="copyJson">Copy JSON</button>
              <button class="btn" id="downloadJson">Download JSON</button>
              <button class="btn" id="resetForm">Reset</button>
            </div>
            <div class="note">Your rating is stored locally on this device (no account needed). Use “Copy JSON” or “Download JSON” to share or upload later.</div>
          </div>
        </div>
        <div>
          <div class="small muted" style="margin-bottom:8px">QR code</div>
          <div class="qrbox">
            <img id="qr" alt="QR code"/>
          </div>
          <div class="small muted" style="margin-top:10px">
            If the image doesn’t load, <a id="qrRaw" target="_blank">open the QR directly</a>.
          </div>
        </div>
      </div>
    </div>

    <div id="list" class="panel hidden">
      <input id="q" type="search" placeholder="Search by ID, Brand, Name, Vitola…" />
      <div class="list" id="items" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    const JSON_CANDIDATES = ["./items_v2.json","./items.json"];
    function qs(k){return new URL(window.location.href).searchParams.get(k);}
    function showToast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),1800); }

    async function loadData(){
      for(const url of JSON_CANDIDATES){
        try{ const r=await fetch(url,{cache:"no-store"}); if(r.ok){ return {data:await r.json(), url}; } }catch(e){}
      }
      throw new Error("Could not load items_v2.json or items.json. Upload one of them next to index.html.");
    }

    function nice(v){ return (v && String(v).trim()) ? v : "Not specified"; }

    function field(k,v){
      const L=document.createElement("div"); L.className="label"; L.textContent=k;
      const V=document.createElement("div"); V.className="value";
      if(k==="Reveal Link" && v && v!=="Not specified"){ const a=document.createElement("a"); a.href=v; a.textContent=v; a.target="_blank"; V.appendChild(a); }
      else{ V.textContent=v; }
      return [L,V];
    }

    function renderStars(containerKey, initial=0){
      const wrap = document.querySelector(`.stars[data-stars="${containerKey}"]`);
      wrap.innerHTML="";
      for(let i=1;i<=5;i++){
        const s=document.createElement("span"); s.className="star"; s.textContent="★"; s.dataset.value=String(i);
        s.addEventListener("click", ()=> setStarValue(containerKey, i));
        wrap.appendChild(s);
      }
      setStarValue(containerKey, initial);
    }
    function setStarValue(key, val){
      const wrap=document.querySelector(`.stars[data-stars="${key}"]`);
      wrap.querySelectorAll(".star").forEach(el=>{
        el.dataset.active = Number(el.dataset.value) <= val ? "true":"false";
      });
      wrap.dataset.value = String(val);
    }
    function getStarValue(key){
      const wrap=document.querySelector(`.stars[data-stars="${key}"]`);
      return Number(wrap?.dataset?.value || 0);
    }

    function bindYesNo(key){
      document.querySelectorAll(`.chip[data-yn="${key}"]`).forEach(el=>{
        el.addEventListener("click", ()=>{
          document.querySelectorAll(`.chip[data-yn="${key}"]`).forEach(c=>c.dataset.on="false");
          el.dataset.on="true";
        });
      });
    }
    function getYesNo(key){
      const on = document.querySelector(`.chip[data-yn="${key}"][data-on="true"]`);
      return on ? on.dataset.value : "";
    }
    function setYesNo(key,val){
      document.querySelectorAll(`.chip[data-yn="${key}"]`).forEach(c=> c.dataset.on = (c.dataset.value===val) ? "true" : "false");
    }

    function exportPayload(id, rec){
      const payload = {
        id, brand: rec.Brand||"", name: rec.Name||"", vitola: rec.Vitola||"",
        ratings:{
          flavour_profile: getStarValue("flavour_profile"),
          appearance: getStarValue("appearance"),
          draw: getStarValue("draw"),
          construction: getStarValue("construction"),
          overall: getStarValue("overall"),
        },
        questions:{
          order_again: getYesNo("order_again"),
          gift_smoke: getYesNo("gift_smoke"),
          guessed_flavour: getYesNo("guessed_flavour"),
        },
        feedback: (document.getElementById("feedbackBox").value||"").trim(),
        timestamp: new Date().toISOString()
      };
      return payload;
    }

    function saveLocal(id, payload){
      const key = "crc_ratings";
      const all = JSON.parse(localStorage.getItem(key) || "{}");
      all[id] = payload;
      localStorage.setItem(key, JSON.stringify(all));
    }
    function loadLocal(id){
      try{
        const all = JSON.parse(localStorage.getItem("crc_ratings") || "{}");
        return all[id] || null;
      }catch(e){ return null; }
    }

    function hydrateForm(saved){
      if(!saved) return;
      setStarValue("flavour_profile", saved.ratings?.flavour_profile || 0);
      setStarValue("appearance", saved.ratings?.appearance || 0);
      setStarValue("draw", saved.ratings?.draw || 0);
      setStarValue("construction", saved.ratings?.construction || 0);
      setStarValue("overall", saved.ratings?.overall || 0);
      setYesNo("order_again", saved.questions?.order_again || "");
      setYesNo("gift_smoke", saved.questions?.gift_smoke || "");
      setYesNo("guessed_flavour", saved.questions?.guessed_flavour || "");
      document.getElementById("feedbackBox").value = saved.feedback || "";
    }

    function resetForm(){
      ["flavour_profile","appearance","draw","construction","overall"].forEach(k=> setStarValue(k,0));
      ["order_again","gift_smoke","guessed_flavour"].forEach(k=> setYesNo(k,""));
      document.getElementById("feedbackBox").value = "";
    }

    function download(filename, text){
      const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([text], {type:"application/json"}));
      a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function renderDetail(rec, id){
      document.getElementById("status").classList.add("hidden");
      document.getElementById("detail").classList.remove("hidden");

      const fields=document.getElementById("fields");
      fields.innerHTML="";
      const keys=["Batch","Brand","Name","Vitola","Origin","Wrapper","Binder","Filler","Strength","Flavour","Notes","Reveal Link","ID"];
      keys.forEach(k=>{ const [L,V]=field(k,nice(rec[k])); fields.appendChild(L); fields.appendChild(V); });

      // QR
      const url = rec.QR_URL || "";
      const qrURL = "https://chart.googleapis.com/chart?cht=qr&chs=380x380&chl="+encodeURIComponent(url);
      document.getElementById("qr").src = qrURL;
      document.getElementById("qrRaw").href = qrURL;

      // CTA link
      const open = document.getElementById("openLink");
      open.href = rec["Reveal Link"] && rec["Reveal Link"].trim() ? rec["Reveal Link"] : url || "./";

      // Stars & toggles
      ["flavour_profile","appearance","draw","construction","overall"].forEach(k=> renderStars(k,0));
      ["order_again","gift_smoke","guessed_flavour"].forEach(bindYesNo);

      // Hydrate from local storage if exists
      hydrateForm(loadLocal(id));

      // Buttons
      document.getElementById("saveLocal").onclick = ()=>{
        const payload = exportPayload(id, rec);
        saveLocal(id, payload);
        showToast("Saved on this device");
      };
      document.getElementById("copyJson").onclick = async ()=>{
        const payload = exportPayload(id, rec);
        await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
        showToast("Copied JSON");
      };
      document.getElementById("downloadJson").onclick = ()=>{
        const payload = exportPayload(id, rec);
        download(`${id}-rating.json`, JSON.stringify(payload, null, 2));
      };
      document.getElementById("resetForm").onclick = ()=>{
        resetForm(); showToast("Cleared");
      };
    }

    function renderList(all){
      document.getElementById("status").classList.add("hidden");
      const list=document.getElementById("list");
      list.classList.remove("hidden");
      const items=document.getElementById("items");
      const q=document.getElementById("q");

      function card([id,rec]){
        const div=document.createElement("div"); div.className="item";
        const left=document.createElement("div");
        const title=document.createElement("div");
        title.innerHTML = "<strong>"+(nice(rec.Name))+"</strong> • "+(nice(rec.Brand))+(rec.Vitola? " — "+nice(rec.Vitola):"");
        const meta=document.createElement("div"); meta.className="meta";
        meta.textContent = "ID: "+id+"  |  Origin: "+nice(rec.Origin);
        left.appendChild(title); left.appendChild(meta);
        const right=document.createElement("div");
        const a=document.createElement("a"); a.className="linkbtn"; a.textContent="Open"; a.href="./?id="+encodeURIComponent(id);
        right.appendChild(a);
        div.appendChild(left); div.appendChild(right);
        return div;
      }

      function update(){
        const term=q.value.toLowerCase();
        items.innerHTML="";
        Object.entries(all).filter(([id,rec])=>{
          const hay=[id,rec.Name,rec.Brand,rec.Vitola,rec.Origin].join(" ").toLowerCase();
          return hay.includes(term);
        }).slice(0,500).forEach(entry=>items.appendChild(card(entry)));
      }

      q.addEventListener("input", update);
      update();
    }

    (async function(){
      try{
        const {data}=await loadData();
        const id=qs("id");
        if(id){
          const rec=data[id];
          if(!rec){ throw new Error("No match for ID: "+id+". Check the ID in your spreadsheet and items.json key."); }
          renderDetail(rec, id);
        }else{
          renderList(data);
        }
      }catch(e){
        const s=document.getElementById("status");
        s.textContent = e.message;
      }
    })();
  </script>
</body>
</html>
